<!DOCTYPE html>
<html lang="kr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    <link rel="stylesheet" href="./css/style.css">
    <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
    <!-- <script src="http://maps.google.com/maps/api/js?sensor=false"type="text/javascript"></script> -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBZ9FRe2oX-w0zkDv2avFJK1LKxY4g3M-M"></script>
    <title>사용자 감지 시간</title>
</head>
<body>
    <div class="app">
        <div class="side_content">
            <div class="side_top">
                <a href="/"><img src="./images/logo.png" alt=""></a>
            </div>
            <div class="side_main">
                <div class="area_box">
                    <span class="boll"></span>
                    <span class="txt">연수구</span>
                </div>
                <ul class="side_nav_box">
                    <li>
                        <a  href="/price.html">
                            <span class="icon"><i class="fas fa-list-alt lg"></i></span>
                            <span class="txt">사용 금액 조회</span>
                        </a>
                    </li>
                    <li>
                        <a href="/" class="active">
                            <span class="icon"><i class="fas fa-history"></i></span>
                            <span class="txt">사용자 감지 시간</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="main_content">
            <div class="main_top_icon_box">
                <a href="#"><img src="./images/homeButton@2x.png" alt=""></a>
                <a href="#"><img src="./images/shape@2x.png" alt=""></a>
            </div>
            <div class="content_box">
                <div class="content_top">
                    <div class="item_left item1 item">
                        <div class="img_box">
                            <img src="./images/invalidName3@2x.png" alt="">
                        </div>
                        <div class="map_box">
                            <div class="map" id="map">
                                <!-- <img src="./images/samplemap.png" alt=""> -->
                            </div>
                            <div class="map_btn_box">
                                <button class="btn1">
                                    <span class="line1"></span>
                                    <span class="line2"></span>
                                </button>
                                <button class="btn2">
                                    <span class="line1"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="item_right item2 item">
                        <div class="img_box">
                            <img src="./images/invalidName@2x.png" alt="">
                        </div>
                        <div class="notice_content">
                            <div class="title_box">
                                <strong>공지사항</strong>
                                <button class="icon_box">
                                    <span class="line1"></span>
                                    <span class="line2"></span>
                                </button>
                            </div>
                            <div class="list_box">
                                <ul>
                                    
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="content_btm">
                    <div class="item3 item">
                        <div class="img_box">
                            <img src="./images/invalidName2@2x.png" alt="">
                        </div>
                        <div class="title_box">
                            <strong>사용자 감지 시간</strong>
                        </div>
                        <div class="table_box" id="table_box">
                            <table>
                                <thead>
                                    <tr>
                                        <th>순번</th>
                                        <th>성명</th>
                                        <th>세싱 된 시간</th>
                                        <th>주소 (연수구)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- <tr>
                                        <td class="num">1</td>
                                        <td class="name">고길동</td>
                                        <td class="date">10월 20일 09시 30분</td>
                                        <td class="location">송도 국제대로 260 아파트 2001호</td>
                                    </tr>
                                    <tr>
                                        <td class="num">2</td>
                                        <td class="name">고길동</td>
                                        <td class="date">10월 20일 09시 30분</td>
                                        <td class="location">송도 국제대로 260 아파트 2001호</td>
                                    </tr>
                                    <tr>
                                        <td class="num">3</td>
                                        <td class="name">고길동</td>
                                        <td class="date">10월 20일 09시 30분</td>
                                        <td class="location">송도 국제대로 260 아파트 2001호</td>
                                    </tr>
                                    <tr>
                                        <td class="num">4</td>
                                        <td class="name">고길동</td>
                                        <td class="date">10월 20일 09시 30분</td>
                                        <td class="location">송도 국제대로 260 아파트 2001호</td>
                                    </tr>
                                    <tr>
                                        <td class="num">5</td>
                                        <td class="name">고길동</td>
                                        <td class="date">10월 20일 09시 30분</td>
                                        <td class="location">송도 국제대로 260 아파트 2001호</td>
                                    </tr> -->
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination_box">
                            <ul id="pagination">
                                <!-- <li><a href="#">FIRST</a></li>
                                <li><a href="#">PREV</a></li>
                                <li><a href="#" class="active">1</a></li>
                                <li><a href="#">2</a></li>
                                <li><a href="#">3</a></li>
                                <li><a href="#">4</a></li>
                                <li><a href="#">5</a></li>
                                <li><a href="#">NEXT</a></li>
                                <li><a href="#">LAST</a></li> -->
                            </ul>
                        </div>
                        <!-- <div id="pagination" style="text-align: center"></div> -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(function(){
            function AJAX() {
                var noticeUl = document.querySelector('.notice_content .list_box ul')
                $.ajax({
                    url: 'http://ec2-13-125-22-29.ap-northeast-2.compute.amazonaws.com/notify.php',
                    type: 'GET',
                    data: {
                        // 보낼 데이터
                    },
                    dataType: 'json'
                })
                    .done(function(res) {
                        // 성공 시 동작
                        console.log('성공' , res)
                        for(var i = 0; i < 8; i += 1) {
                            if (res[i] === undefined) {
                                return false
                            }
                            var date = res[i].date.split(' ')
                            noticeUl.insertAdjacentHTML(
                                'afterbegin', 
                                "<li><span class=\"list_title\">" + res[i].title + "</span><span class=\"list_date\">" + date[0] + "</span></li>"
                            );

                        }
                        
                    })
                    .fail(function(error) {
                        // 실패 시 동작
                        console.log('에러' ,error)
                    })
                    .always(function(response) {
                        // 완료 시 동작
                    }); 

                $.ajax({
                    url: 'http://ec2-13-125-22-29.ap-northeast-2.compute.amazonaws.com/all.php',
                    type: 'GET',
                    data: {
                        // 보낼 데이터
                    },
                    dataType: 'json'
                })
                    .done(function(res) {
                        // 성공 시 동작
                        console.log('성공' , res)
                        var list = res.human;
                        var pageCount = 5;
                        var blockCount = 5;
                        var totalPage = Math.ceil(list.length / pageCount);
                        var totalBlock = Math.ceil(totalPage / blockCount);
                        var pagination = document.getElementById('pagination');  
                        var tableBox = document.getElementById('table_box').querySelector('tbody');
                        var renderTable = function(page) {
                            var startNum = (pageCount * (page - 1));
                            var endNum = ((pageCount * page) >= list.length) ? list.length : (pageCount * page);

                            var html = '';
                            var locations = []
                            for (var index = startNum; index < endNum; index++) {
                                var date = res.sensor[index].date.split(' ')
                                var newDate = date[0].split('-')
                                var newHour = date[1].split(':')
                                html += "<tr><td class=\"num\">" + list[index].person_id + "</td><td class=\"name\">" + list[index].name + "</td><td class=\"date\">" + newDate[1] + "월 " + newDate[2] + "일 " + newHour[0] + "시 " + newHour[1] + "분</td><td class=\"location\">" + list[index].address + "</td></tr>";
                                locations.push([list[index].name , list[index].lat , list[index].lng])            
                            }
                            // 구글맵 start
                            var map = new google.maps.Map(document.getElementById('map'), {
                                zoom: 12,
                                center: new google.maps.LatLng(locations[0][1],locations[0][2]),
                                mapTypeId: google.maps.MapTypeId.ROADMAP
                            });

                            var infowindow = new google.maps.InfoWindow();

                            var marker, i;
                            for (i = 0; i < locations.length; i++) {  
                                marker = new google.maps.Marker({
                                    id:i,
                                    position: new google.maps.LatLng(locations[i][1], locations[i][2]),
                                    map: map
                                });

                                google.maps.event.addListener(marker, 'click', (function(marker, i) {
                                    return function() {
                                    infowindow.setContent(locations[i][0]);
                                    infowindow.open(map, marker);
                                    }
                                })(marker, i));
                                if(marker){
                                    marker.addListener('click', function() {
                                    map.setZoom(15);
                                    map.setCenter(this.getPosition());
                                    });
                                 }
                            }
                            // 구글맵 end
                            

                            tableBox.innerHTML = html;
                        };
                        var renderPagination = function(page) {
                            var block = Math.floor((page-1)/blockCount)+1;
                            var startPage = ((block-1)*blockCount)+1;
                            var endPage = ((startPage + blockCount -1) > totalPage) ? totalPage : (startPage + blockCount -1);

                            var paginationHTML = '';

                            if (page !== 1) paginationHTML += "<li><a style='cursor:pointer' class='first_page'>FIRST</a></li>";
                            if (block !== 1) paginationHTML += "<li><a style='cursor:pointer' class='back_page'>PREV</a></li>   ";
                            

                            for (var index = startPage; index <= endPage; index++) {
                                paginationHTML += (parseInt(page) === parseInt(index)) ?
                                "<li><a class=\"active\">" + index + "</a></li>" : "<li><a style='cursor: pointer' class='go_page' data-value='" + index + "'>" + index + "</a></li>";

                                
                                    
                            }

                            if (block < totalBlock) paginationHTML += "<li><a style='cursor:pointer' class='next_page'>NEXT</a></li>";
                            if (page < totalPage) paginationHTML += "<li><a style='cursor:pointer' class='last_page'>LAST</a></li>";

                            pagination.innerHTML = paginationHTML;
                            addEventPagination(startPage, endPage);
                        };
                        var renderTableAndPagination = function(page = 1) {
                            renderTable(page);
                            renderPagination(page);
                        };
                        
                        var addEventPagination = function(startPage, endPage){
                            if (!!document.querySelector(".first_page")) {
                                document.querySelector(".first_page").addEventListener('click', () => {
                                    renderTableAndPagination(1);
                                });
                            }

                            if (!!document.querySelector(".back_page")) {
                                document.querySelector(".back_page").addEventListener('click', () => {
                                    renderTableAndPagination(startPage-1);
                                });
                            }

                            document.querySelectorAll(".go_page").forEach(goPage => {
                                goPage.addEventListener('click', e => {
                                    renderTableAndPagination(parseInt(e.target.getAttribute('data-value')));
                                });
                            });

                            if (!!document.querySelector(".next_page")) {
                                document.querySelector(".next_page").addEventListener('click', () => {
                                    renderTableAndPagination(endPage + 1);
                                });
                            }

                            if (!!document.querySelector(".last_page")) {
                                document.querySelector(".last_page").addEventListener('click', () => {
                                    renderTableAndPagination(totalPage);
                                });
                            }
                        };

                        renderTableAndPagination()

                        
                        
                    })
                    .fail(function(error) {
                        // 실패 시 동작
                        console.log('에러' ,error)
                    })
                    .always(function(response) {
                        // 완료 시 동작
                    }); 
            } 
            AJAX()  



            
            
            
            
            


            
            
        })
    </script>
</body>
</html>